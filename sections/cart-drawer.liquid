<div id="cart-drawer" x-data="cartDrawer()" x-cloak class="fixed inset-y-0 right-0 w-full max-w-md bg-white shadow-xl translate-x-full transition-transform" :class="{ '-translate-x-0': open }">
  <div class="flex items-center justify-between p-4 border-b">
    <h3 class="text-lg font-semibold">Your cart</h3>
    <button @click="close" class="text-gray-500 hover:text-gray-700">Close</button>
  </div>
  <div class="p-4" x-html="itemsHtml"></div>
  <div class="p-4 border-t flex items-center justify-between">
    <span class="font-medium">Subtotal</span>
    <span x-text="subtotal"></span>
  </div>
  <div class="p-4"><a href="/cart" class="btn-primary w-full text-center block">Go to cart</a></div>
</div>

<script>
  function cartDrawer() {
    return {
      open: false,
      itemsHtml: '',
      subtotal: '',
      async refresh() {
        const res = await fetch('/cart?view=mini')
        this.itemsHtml = await res.text()
        const cart = await (await fetch('/cart.js')).json()
        this.subtotal = Shopify.formatMoney(cart.items_subtotal_price)
      },
      async add(variantId, quantity = 1) {
        await fetch('/cart/add.js', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: variantId, quantity }) })
        await this.refresh(); this.open = true
      },
      close() { this.open = false }
    }
  }

  document.addEventListener('alpine:init', () => {
    const drawer = document.getElementById('cart-drawer')
    document.body.addEventListener('click', (e) => {
      const addBtn = e.target.closest('[data-quick-add]')
      if (addBtn && drawer && drawer.__x) {
        e.preventDefault()
        drawer.__x.$data.add(addBtn.getAttribute('data-variant-id'))
      }
    })
  })
</script>
